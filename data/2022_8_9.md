### tcp协议(2.交互流程)

![http://files.gxklyzm.cn/2022-8-8/tcp_process.jpg](http://files.gxklyzm.cn/2022-8-8/tcp_process.jpg)
###### *<u>\*注: 图片来自书籍《网络是怎样连接的》</u>*

<br/>

tcp连接主要包括三部分:
1. 建立连接
2. 数据传输
3. 断开连接

<br/>

**建立连接步骤:**

主机A会发送一个头部携带SYN=1的TCP包发送给主机B，
除了SYN之外TCP头部还会携带主机A向主机B发送数据时使用的初始序列号，
以及主机A可以接收主机B发送的数据窗口大小。

当主机B接收到主机A发送的TCP包之后，
和主机A一样，也会返回给主机A一个SYN=1并且包含初始序列号和数据窗口大小的TCP包，
这个返回的TCP包头还会包含ACK号，
代表主机B已经确认收到了主机A的数据包。

当主机B回应的TCP包被主机A接收到之后，主机A紧接着就会返回给主机B一个包含ACK确认号的TCP包。

经过上面的这三次交互，连接操作就完成了，双方进入数据收发阶段。

这三次交互也叫**TCP的三次握手**。


<br/>

**数据传输步骤:**

数据收发阶段的操作根据应用程序的不同而有一些差异，
以大多数为例，
主机A首先会向主机B发送一条请求（或其他）消息。
TCP会将这条消息分割成一定的大小的数据块，并且每块数据都要加上TCP的头部，然后发送。

TCP的头部包含序号，它表示当前发送的是第几个字节。
例如：初始序号为1，长度为100，第二个数据块的序号就是101。

当主机B收到数据时，会向主机A返回一条带有ACK号的数据，代表期望下一次接收的数据从那个序列号开始。
例如：主机A发送过来的数据初始序号是1，长度为100，主机B接收成功后，返回的ACK号就是101。
需要注意的是TCP包头部的控制位中的ACK=1的时候，ACK号才会生效，否则就会忽略ACK字段。

在最初的阶段，
主机B只是不断接收数据，
随着数据收发的进行，
主机B处理数据的速度要是跟不上主机A发送数据的速度，主机B的缓冲区就不能立刻得到释放，
因为在建立连接的时候就已经确定的双方数据缓冲区的大小也就是数据窗口的大小，
主机A如果一直接收不到主机B返回新的窗口大小，
就会判断主机B的缓冲区是否快使用完了，如果是的话，主机A就会暂停发送数据，等待主机B缓冲区的释放。
等到数据不断传递给应用程序，接收缓冲区就会被逐步释放。这时，主机B需要将新的窗口大小告知主机A。

如果主机B处理完主机A的消息后，需要给主机A返回响应数据的时候，这个过程和刚才的过程正好相反。

#### 图示:
![http://files.gxklyzm.cn/2022-8-8/tcp_send.jpg](http://files.gxklyzm.cn/2022-8-8/tcp_send.jpg)
###### *<u>\*注: 图片来自书籍《网络是怎样连接的》</u>*


<br/>

**断开连接步骤:**

数据收发操作就结束后，任意一方就可以主动执行断开操作了。

还是以主机A主动发送请求为例，主机A会先发送一个TCP头部控制位中的FIN=1的数据包给主机B，表示我要和你断开连接。
主机B收到主机A的数据包之后，就会返回给主机A一个携带ACK号的确认包，表示我确认了你的断开请求。

之后主机B再给主机A发送一个TCP头部控制位中的FIN=1的数据包，表示我也要和你断开连接。
主机A收到主机B的断开请求的数据包之后，也会给主机B返回一个携带ACK号的确认包，表示我也确认了你的断开请求。

经过上面的四次交互之后，主机A就和主机B彻底断开了连接。

这四次交互也叫**TCP的四次挥手**。


<br />


###### 内容参考书籍《网络是怎样连接的》